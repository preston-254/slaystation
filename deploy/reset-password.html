<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - Slay Station</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--light-bg) 0%, #FFF0F5 100%);
            padding: 100px 20px 50px;
        }
        
        .auth-box {
            background: white;
            padding: 3rem;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            max-width: 450px;
            width: 100%;
            animation: fadeInUp 0.5s ease;
        }
        
        .auth-box h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--primary-pink), var(--purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            text-align: center;
        }
        
        .auth-box input {
            width: 100%;
            padding: 1rem;
            border: 2px solid var(--light-bg);
            border-radius: 10px;
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            margin-bottom: 1rem;
            transition: border-color 0.3s;
            box-sizing: border-box;
        }
        
        .auth-box input:focus {
            outline: none;
            border-color: var(--primary-pink);
        }
        
        .auth-btn {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, var(--primary-pink), var(--purple));
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 1rem;
        }
        
        .auth-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(255, 107, 157, 0.4);
        }
        
        .password-field {
            position: relative;
            margin-bottom: 1rem;
        }
        
        .password-toggle {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            padding: 0.5rem;
            font-size: 1.2rem;
            z-index: 10;
            transition: color 0.3s;
        }
        
        .password-toggle:hover {
            color: var(--primary-pink);
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body>
    <div class="auth-container">
        <div class="auth-box">
            <h1>üîê Reset Password</h1>
            <p style="color: #666; margin-bottom: 0.5rem; text-align: center; font-weight: 600;">Create Your New Password</p>
            <p style="color: #999; margin-bottom: 2rem; text-align: center; font-size: 0.9rem;">Enter and confirm your new password below</p>
            
            <div id="errorMessage" style="display: none;"></div>
            <div id="successMessage" style="display: none;"></div>
            
            <form id="resetPasswordForm" onsubmit="handlePasswordReset(event)">
                <div class="password-field">
                    <input type="password" id="newPassword" placeholder="Enter new password (min 6 characters)" required minlength="6" style="padding-right: 3rem;" autocomplete="new-password">
                    <button type="button" class="password-toggle" onclick="togglePasswordVisibility('newPassword', 'toggleNewPassword')" id="toggleNewPassword" title="Show/Hide Password">üëÅÔ∏è</button>
                </div>
                <div class="password-field">
                    <input type="password" id="confirmPassword" placeholder="Confirm new password" required minlength="6" style="padding-right: 3rem;" autocomplete="new-password">
                    <button type="button" class="password-toggle" onclick="togglePasswordVisibility('confirmPassword', 'toggleConfirmPassword')" id="toggleConfirmPassword" title="Show/Hide Password">üëÅÔ∏è</button>
                </div>
                <button type="submit" class="auth-btn" id="resetBtn">Reset Password ‚ú®</button>
            </form>
            
            <div style="text-align: center; margin-top: 1.5rem;">
                <a href="login.html" style="color: var(--primary-pink); text-decoration: none; font-weight: 600;">‚Üê Back to Login</a>
            </div>
        </div>
    </div>

    <script src="auth.js"></script>
    <script>
        // Get token and email from URL (decode email in case it's encoded)
        const urlParams = new URLSearchParams(window.location.search);
        let token = urlParams.get('token');
        let email = urlParams.get('email');
        
        // Decode email if it's URL encoded
        if (email) {
            email = decodeURIComponent(email).toLowerCase();
        }
        
        // Store token and email globally for use in handlePasswordReset
        let resetToken = token;
        let resetEmail = email;
        
        // Validate token on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Reset password page loaded');
            console.log('Token:', token);
            console.log('Email:', email);
            
            if (!token || !email) {
                showError('Invalid reset link. Missing token or email. Please request a new password reset.');
                document.getElementById('resetPasswordForm').style.display = 'none';
                return;
            }
            
            // Check if token is valid
            const resetTokens = JSON.parse(localStorage.getItem('slayStationResetTokens') || '{}');
            console.log('Stored tokens:', resetTokens);
            
            // Try to find token by email (case-insensitive)
            let tokenData = null;
            for (const [storedEmail, data] of Object.entries(resetTokens)) {
                if (storedEmail.toLowerCase() === email.toLowerCase()) {
                    tokenData = data;
                    break;
                }
            }
            
            console.log('Token data found:', tokenData);
            
            if (!tokenData) {
                showError('Reset token not found. Please request a new password reset link.');
                document.getElementById('resetPasswordForm').style.display = 'none';
                return;
            }
            
            if (tokenData.token !== token) {
                console.error('Token mismatch. Expected:', tokenData.token, 'Got:', token);
                showError('Invalid reset token. Please request a new password reset.');
                document.getElementById('resetPasswordForm').style.display = 'none';
                return;
            }
            
            // Check if token has expired
            if (Date.now() > tokenData.expiry) {
                showError('Reset link has expired. Please request a new password reset.');
                document.getElementById('resetPasswordForm').style.display = 'none';
                delete resetTokens[email.toLowerCase()];
                localStorage.setItem('slayStationResetTokens', JSON.stringify(resetTokens));
                return;
            }
            
            console.log('Token validated successfully!');
        });
        
        function handlePasswordReset(e) {
            e.preventDefault();
            
            // Disable button to prevent double submission
            const resetBtn = document.getElementById('resetBtn');
            if (resetBtn) {
                resetBtn.disabled = true;
                resetBtn.textContent = 'Resetting Password...';
            }
            
            if (!resetToken || !resetEmail) {
                showError('Invalid reset link.');
                if (resetBtn) {
                    resetBtn.disabled = false;
                    resetBtn.textContent = 'Reset Password ‚ú®';
                }
                return;
            }
            
            const newPasswordInput = document.getElementById('newPassword');
            const confirmPasswordInput = document.getElementById('confirmPassword');
            
            if (!newPasswordInput || !confirmPasswordInput) {
                showError('Form fields not found. Please refresh the page.');
                if (resetBtn) {
                    resetBtn.disabled = false;
                    resetBtn.textContent = 'Reset Password ‚ú®';
                }
                return;
            }
            
            const newPassword = newPasswordInput.value.trim();
            const confirmPassword = confirmPasswordInput.value.trim();
            
            if (!newPassword || newPassword.length < 6) {
                showError('Password must be at least 6 characters long');
                newPasswordInput.focus();
                if (resetBtn) {
                    resetBtn.disabled = false;
                    resetBtn.textContent = 'Reset Password ‚ú®';
                }
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showError('Passwords do not match. Please try again.');
                confirmPasswordInput.value = '';
                confirmPasswordInput.focus();
                if (resetBtn) {
                    resetBtn.disabled = false;
                    resetBtn.textContent = 'Reset Password ‚ú®';
                }
                return;
            }
            
            // Verify token again
            const resetTokens = JSON.parse(localStorage.getItem('slayStationResetTokens') || '{}');
            
            // Find token data (case-insensitive email match)
            let tokenData = null;
            let tokenEmail = null;
            for (const [storedEmail, data] of Object.entries(resetTokens)) {
                if (storedEmail.toLowerCase() === resetEmail.toLowerCase()) {
                    tokenData = data;
                    tokenEmail = storedEmail;
                    break;
                }
            }
            
            if (!tokenData || tokenData.token !== resetToken || Date.now() > tokenData.expiry) {
                showError('Reset link has expired. Please request a new password reset.');
                if (resetBtn) {
                    resetBtn.disabled = false;
                    resetBtn.textContent = 'Reset Password ‚ú®';
                }
                return;
            }
            
            // Update password in user account
            const users = JSON.parse(localStorage.getItem('slayStationUsers') || '[]');
            const userIndex = users.findIndex(u => u.email.toLowerCase() === resetEmail.toLowerCase());
            
            if (userIndex !== -1) {
                // Update the user's password
                users[userIndex].password = newPassword;
                users[userIndex].passwordUpdatedAt = new Date().toISOString();
                localStorage.setItem('slayStationUsers', JSON.stringify(users));
                
                console.log('Password updated successfully for:', resetEmail);
                
                // Remove used token
                if (tokenEmail) {
                    delete resetTokens[tokenEmail];
                }
                localStorage.setItem('slayStationResetTokens', JSON.stringify(resetTokens));
                
                // Clear password fields
                newPasswordInput.value = '';
                confirmPasswordInput.value = '';
                
                // Show success message
                showSuccess('‚úÖ Password reset successfully! You can now login with your new password. Redirecting to login page...');
                
                // Disable form to prevent multiple submissions
                document.getElementById('resetPasswordForm').style.pointerEvents = 'none';
                document.getElementById('resetPasswordForm').style.opacity = '0.6';
                
                // Redirect to login page after 2 seconds
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 2000);
            } else {
                showError('User account not found. Please contact support or create a new account.');
                console.error('User not found for email:', resetEmail);
            }
        }
        
        function togglePasswordVisibility(inputId, buttonId) {
            const passwordInput = document.getElementById(inputId);
            const toggleButton = document.getElementById(buttonId);
            
            if (passwordInput && toggleButton) {
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    toggleButton.textContent = 'üôà';
                    toggleButton.title = 'Hide Password';
                } else {
                    passwordInput.type = 'password';
                    toggleButton.textContent = 'üëÅÔ∏è';
                    toggleButton.title = 'Show Password';
                }
            }
        }
        
        function showError(message) {
            // Remove any existing messages
            const existingError = document.getElementById('errorMessage');
            const existingSuccess = document.getElementById('successMessage');
            if (existingError) existingError.style.display = 'none';
            if (existingSuccess) existingSuccess.style.display = 'none';
            
            // Show error message
            const errorDiv = document.getElementById('errorMessage');
            if (errorDiv) {
                errorDiv.style.cssText = 'background: #ffebee; color: #c62828; padding: 1rem; border-radius: 10px; margin-bottom: 1rem; border: 2px solid #ef5350; text-align: center; font-weight: 600; display: block;';
                errorDiv.textContent = message;
            } else {
                // Fallback: create new element
                const newErrorDiv = document.createElement('div');
                newErrorDiv.id = 'errorMessage';
                newErrorDiv.style.cssText = 'background: #ffebee; color: #c62828; padding: 1rem; border-radius: 10px; margin-bottom: 1rem; border: 2px solid #ef5350; text-align: center; font-weight: 600;';
                newErrorDiv.textContent = message;
                
                const form = document.getElementById('resetPasswordForm');
                if (form && form.parentNode) {
                    form.parentNode.insertBefore(newErrorDiv, form);
                }
            }
        }
        
        function showSuccess(message) {
            // Remove any existing messages
            const existingError = document.getElementById('errorMessage');
            const existingSuccess = document.getElementById('successMessage');
            if (existingError) existingError.style.display = 'none';
            if (existingSuccess) existingSuccess.style.display = 'none';
            
            // Show success message
            const successDiv = document.getElementById('successMessage');
            if (successDiv) {
                successDiv.style.cssText = 'background: #e8f5e9; color: #2e7d32; padding: 1rem; border-radius: 10px; margin-bottom: 1rem; border: 2px solid #4caf50; text-align: center; font-weight: 600; display: block;';
                successDiv.textContent = message;
            } else {
                // Fallback: create new element
                const newSuccessDiv = document.createElement('div');
                newSuccessDiv.id = 'successMessage';
                newSuccessDiv.style.cssText = 'background: #e8f5e9; color: #2e7d32; padding: 1rem; border-radius: 10px; margin-bottom: 1rem; border: 2px solid #4caf50; text-align: center; font-weight: 600;';
                newSuccessDiv.textContent = message;
                
                const form = document.getElementById('resetPasswordForm');
                if (form && form.parentNode) {
                    form.parentNode.insertBefore(newSuccessDiv, form);
                }
            }
        }
    </script>
</body>
</html>

